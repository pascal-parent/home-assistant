title: "Electricity"
path: "electricity"

cards:
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        cards:
          - type: "custom:button-card"
            template: chip_back
            variables:
              ulm_chip_back_path: home

          - type: "custom:button-card"
            template: custom_card_title
            name: "Energy"

          - type: "custom:button-card"
            color_type: blank-card

          - type: "custom:button-card"
            template: custom_chip_mdi_text_icon_state
            variables:
              ulm_chip_mdi_icon_state_entity: sensor.load_shedding_stage_eskom
              ulm_chip_mdi_icon_state_icon: mdi:transmission-tower
              ulm_chip_mdi_icon_state_text: ""

      - type: vertical-stack
        in_card: true
        cards:
          # ----------------------------------------------------------------------------
          # Electricity consumption
          # ----------------------------------------------------------------------------

          - type: custom:power-flow-card
            title: Overview
            kw_decimals: 2
            entities:
              battery: sensor.sunsynk_battery_power
              battery_charge: sensor.sunsynk_battery_soc
              grid:
                consumption: sensor.sunsynk_grid_power
              solar: sensor.sunsynk_pv1_power

          # ----------------------------------------------------------------------------
          # Charging status
          # ----------------------------------------------------------------------------
          - type: markdown
            content: |
              {% set pv = states('sensor.sunsynk_pv1_power') | float(0) %}
              {% set ep = states('sensor.sunsynk_essential_power') | float(0) %}
              {% set gp = states('sensor.sunsynk_grid_power') | float(0) %}
              {% set bp = states('sensor.sunsynk_battery_power') | float(0) %}
              {% if is_state('input_boolean.sunsynk_house_batteries_charging', 'on') %}
                {% if (gp > 50) %}
                  <ha-alert alert-type="error">Batteries Charging from Grid</ha-alert>
                {% else %}
                  <ha-alert alert-type="success">Batteries Charging from Solar Panels</ha-alert>
                {% endif %}
              {% else %}
                {% if (bp > 100) %}
                  <ha-alert alert-type="warning">House on batteries</ha-alert>
                {% elif (pv > ep) %}
                  {% if (gp > 50) %}
                    <ha-alert alert-type="success">House on Batteries and Solar Panels</ha-alert>
                  {% else %}
                    <ha-alert alert-type="success">House on Solar Panels</ha-alert>
                  {% endif %}
                {% else %}
                  <ha-alert alert-type="error">House on grid</ha-alert>
                {% endif %}
              {% endif %}
            card_mod:
              style: |
                ha-card {
                  margin-top: 10px;
                  margin-bottom: 10px;
                  background: #372A2900;
                }

      # ----------------------------------------------------------------------------
      # Manual Grid Charge
      # ----------------------------------------------------------------------------
      - type: horizontal-stack
        cards:
          - type: button
            name: Charge batteries to 60%
            show_state: true
            show_icon: true
            icon: mdi:battery-charging-60
            icon_height: 20%
            tap_action:
              action: call-service
              service: script.turn_on
              data:
                entity_id: script.sunsynk_grid_charge_house_batteries_to_60

          - type: horizontal-stack
            cards:
              - type: button
                name: Charge batteries Off
                show_state: false
                show_icon: true
                icon: mdi:battery-off-outline
                icon_height: 20%
                tap_action:
                  action: call-service
                  service: script.turn_on
                  data:
                    entity_id: script.sunsynk_grid_charge_house_batteries_off

      - type: horizontal-stack
        cards:
          #Home panel horseshoe
          - type: vertical-stack
            in_card: true
            cards:
              - type: custom:flex-horseshoe-card
                entities:
                  - entity: sensor.sunsynk_load_power
                    decimals: 0
                    unit: W
                    name: Home
                  - entity: sensor.sunsynk_grid_voltage
                    decimals: 0
                    unit: V
                  - entity: sensor.sunsynk_inverter_current
                    decimals: 1
                    unit: A
                  - entity: sensor.sunsynk_day_load_energy
                    decimals: 2
                    unit: kWh
                    name: Daily
                  - entity: sensor.sunsynk_load_power_daily_maximum
                    decimals: 0
                    unit: W
                    name: Maximum
                show:
                  horseshoe_style: colorstop
                layout:
                  hlines:
                    - id: 0
                      xpos: 50
                      ypos: 40
                      length: 70
                      styles:
                        - opacity: 0.2;
                    - id: 1
                      xpos: 50
                      ypos: 60
                      length: 70
                      styles:
                        - opacity: 0.2;
                  vlines:
                    - id: 0
                      xpos: 50
                      ypos: 50
                      length: 18
                      styles:
                        - opacity: 0.2;
                  states:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 33
                      styles:
                        - font-size: 3em;
                        - opacity: 0.9;
                    - id: 1
                      entity_index: 1
                      xpos: 44
                      ypos: 53
                      styles:
                        - font-size: 1.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 2
                      xpos: 55
                      ypos: 53
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 4
                      entity_index: 3
                      xpos: 0
                      ypos: 7
                      styles:
                        - text-anchor: start;
                        - font-size: 1.2em;
                    - id: 5
                      entity_index: 4
                      xpos: 50
                      ypos: 80
                      styles:
                        - font-size: 2em;
                  icons:
                    - id: 0
                      entity_index: 1
                      xpos: 30
                      ypos: 52
                      align: start
                      size: 1
                  names:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 95
                      styles:
                        - font-size: 1.2em;
                    - id: 2
                      entity_index: 3
                      xpos: 0
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: start;
                    - id: 3
                      entity_index: 4
                      xpos: 50
                      ypos: 68
                      styles:
                        - font-size: 10px;
                horseshoe_scale:
                  min: 0
                  max: 8000
                  width: 6
                color_stops:
                  0: "#9E0000"
                  800: "#FFA81D"
                  2000: "#228127"

              - type: custom:mini-graph-card
                entities:
                  - sensor.sunsynk_pv1_power
                hours_to_show: 24
                height: 150
                show:
                  icon: false
                  name: false
                  state: false
                line_width: 8
                color_thresholds:
                  - value: 0
                    color: "#9E0000"
                  - value: 800
                    color: "#FFA81D"
                  - value: 1800
                    color: "#228127"

          #Solar panel horseshoe
          - type: vertical-stack
            in_card: true
            cards:
              - type: custom:flex-horseshoe-card
                entities:
                  - entity: sensor.sunsynk_pv1_power
                    decimals: 0
                    unit: W
                    name: Solar
                  - entity: sensor.sunsynk_pv1_voltage
                    decimals: 0
                    unit: V
                  - entity: sensor.sunsynk_pv1_current
                    decimals: 1
                    unit: A
                  - entity: sensor.sunsynk_day_pv_energy
                    decimals: 2
                    unit: kWh
                    name: Daily
                  - entity: sensor.energy_production_today_remaining
                    decimals: 2
                    unit: kWh
                    name: Left Today
                  - entity: sensor.solar_panels_daily_maximum_output
                    decimals: 0
                    unit: W
                    name: Maximum
                show:
                  horseshoe_style: colorstop
                layout:
                  hlines:
                    - id: 0
                      xpos: 50
                      ypos: 40
                      length: 70
                      styles:
                        - opacity: 0.2;
                    - id: 1
                      xpos: 50
                      ypos: 60
                      length: 70
                      styles:
                        - opacity: 0.2;
                  vlines:
                    - id: 0
                      xpos: 50
                      ypos: 50
                      length: 18
                      styles:
                        - opacity: 0.2;
                  states:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 33
                      styles:
                        - font-size: 3em;
                        - opacity: 0.9;
                    - id: 1
                      entity_index: 1
                      xpos: 44
                      ypos: 53
                      styles:
                        - font-size: 1.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 2
                      xpos: 55
                      ypos: 53
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 3
                      entity_index: 4
                      xpos: 100
                      ypos: 7
                      styles:
                        - text-anchor: end;
                        - font-size: 1.2em;
                    - id: 4
                      entity_index: 3
                      xpos: 0
                      ypos: 7
                      styles:
                        - text-anchor: start;
                        - font-size: 1.2em;
                    - id: 5
                      entity_index: 5
                      xpos: 50
                      ypos: 80
                      styles:
                        - font-size: 2em;
                  icons:
                    - id: 0
                      entity_index: 1
                      xpos: 30
                      ypos: 52
                      align: start
                      size: 1
                  names:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 95
                      styles:
                        - font-size: 1.2em;
                    - id: 1
                      entity_index: 4
                      xpos: 100
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 3
                      xpos: 0
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: start;
                    - id: 3
                      entity_index: 5
                      xpos: 50
                      ypos: 68
                      styles:
                        - font-size: 10px;
                horseshoe_scale:
                  min: 0
                  max: 4000
                  width: 6
                color_stops:
                  0: "#9E0000"
                  800: "#FFA81D"
                  1800: "#228127"

              - type: custom:mini-graph-card
                entities:
                  - sensor.sunsynk_pv1_power
                hours_to_show: 24
                height: 150
                show:
                  icon: false
                  name: false
                  state: false
                line_width: 8
                color_thresholds:
                  - value: 0
                    color: "#9E0000"
                  - value: 800
                    color: "#FFA81D"
                  - value: 1800
                    color: "#228127"

      - type: horizontal-stack
        cards:
          # Battery State
          - type: vertical-stack
            in_card: true
            cards:
              - type: custom:flex-horseshoe-card
                entities:
                  - entity: sensor.sunsynk_battery_soc
                    decimals: 0
                    unit: "%"
                    name: BATTERY
                  - entity: sensor.sunsynk_battery_voltage
                    decimals: 2
                    unit: V
                  - entity: sensor.sunsynk_battery_current
                    decimals: 2
                    unit: A
                  - entity: sensor.sunsynk_battery_power
                    decimals: 0
                    unit: W
                  - entity: sensor.sunsynk_day_battery_discharge
                    decimals: 2
                    unit: kWh
                    name: Discharge
                  - entity: sensor.sunsynk_day_battery_charge
                    decimals: 2
                    unit: kWh
                    name: Charge
                show:
                  horseshoe_style: colorstop
                layout:
                  hlines:
                    - id: 0
                      xpos: 50
                      ypos: 40
                      length: 70
                      styles:
                        - opacity: 0.2;
                    - id: 1
                      xpos: 50
                      ypos: 60
                      length: 70
                      styles:
                        - opacity: 0.2;
                  vlines:
                    - id: 0
                      xpos: 50
                      ypos: 50
                      length: 18
                      styles:
                        - opacity: 0.2;
                  states:
                    - id: 0
                      entity_index: 3
                      xpos: 50
                      ypos: 33
                      styles:
                        - font-size: 3em;
                        - opacity: 0.9;
                    - id: 1
                      entity_index: 1
                      xpos: 44
                      ypos: 53
                      styles:
                        - font-size: 1.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 2
                      xpos: 55
                      ypos: 53
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 3
                      entity_index: 0
                      xpos: 50
                      ypos: 75
                      styles:
                        - font-size: 2em;
                    - id: 4
                      entity_index: 4
                      xpos: 100
                      ypos: 7
                      styles:
                        - text-anchor: end;
                        - font-size: 1.2em;
                    - id: 5
                      entity_index: 5
                      xpos: 0
                      ypos: 7
                      styles:
                        - text-anchor: start;
                        - font-size: 1.2em;
                  icons:
                    - id: 0
                      entity_index: 3
                      xpos: 30
                      ypos: 52
                      align: start
                      size: 1
                  names:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 95
                      styles:
                        - font-size: 1.2em;
                    - id: 1
                      entity_index: 4
                      xpos: 100
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 5
                      xpos: 0
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: start;
                horseshoe_scale:
                  min: 0
                  max: 100
                  width: 6
                color_stops:
                  0: "#9E0000"
                  20: "#FFA81D"
                  40: "#228127"

              - type: custom:mini-graph-card
                entities:
                  - sensor.sunsynk_battery_power
                hours_to_show: 24
                height: 150
                show:
                  icon: false
                  name: false
                  state: false
                line_width: 8
                color_thresholds:
                  - value: 0
                    color: "#228127"
                  - value: 1
                    color: "#9E0000"

          # Grid horseshoe
          - type: vertical-stack
            in_card: true
            cards:
              - type: custom:flex-horseshoe-card
                entities:
                  - entity: sensor.efergy_power_usage
                    decimals: 0
                    unit: W
                    name: AC
                  - entity: sensor.sunsynk_grid_power
                    decimals: 0
                    unit: W
                    name: Import
                  - entity: sensor.grid_non_essential_power
                    decimals: 0
                    unit: W
                    name: Grid
                  - entity: sensor.sunsynk_grid_voltage
                    decimals: 0
                    unit: V
                  - entity: sensor.sunsynk_grid_voltage
                    decimals: 0
                    unit: V
                  - entity: sensor.sunsynk_grid_current
                    decimals: 1
                    unit: A
                  - entity: sensor.grid_current
                    decimals: 1
                    unit: A
                  - entity: sensor.efergy_daily_consumption
                    decimals: 2
                    unit: kWh
                    name: Daily
                  - entity: sensor.sunsynk_day_grid_import
                    decimals: 2
                    unit: kWh
                    name: Import
                show:
                  horseshoe_style: colorstop
                layout:
                  hlines:
                    - id: 0
                      xpos: 50
                      ypos: 40
                      length: 70
                      styles:
                        - opacity: 0.2;
                  vlines:
                    - id: 0
                      xpos: 50
                      ypos: 59
                      length: 36
                      styles:
                        - opacity: 0.2;
                  states:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 33
                      styles:
                        - font-size: 3em;
                        - opacity: 0.9;
                    - id: 1
                      entity_index: 1
                      xpos: 47
                      ypos: 53
                      styles:
                        - font-size: 1.5em;
                        - text-anchor: end;
                    - id: 2
                      entity_index: 2
                      xpos: 53
                      ypos: 53
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 3
                      entity_index: 3
                      xpos: 46
                      ypos: 63
                      styles:
                        - text-anchor: end;
                        - font-size: 1.5em;
                    - id: 4
                      entity_index: 4
                      xpos: 53
                      ypos: 63
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 5
                      entity_index: 5
                      xpos: 46
                      ypos: 73
                      styles:
                        - text-anchor: end;
                        - font-size: 1.5em;
                    - id: 6
                      entity_index: 6
                      xpos: 53
                      ypos: 73
                      styles:
                        - text-anchor: start;
                        - font-size: 1.5em;
                    - id: 7
                      entity_index: 7
                      xpos: 0
                      ypos: 7
                      styles:
                        - text-anchor: start;
                        - font-size: 1.2em;
                    - id: 8
                      entity_index: 8
                      xpos: 100
                      ypos: 7
                      styles:
                        - text-anchor: end;
                        - font-size: 1.2em;
                  icons:
                    - id: 0
                      entity_index: 1
                      xpos: 1
                      ypos: 53
                      align: start
                      size: 1
                    - id: 1
                      entity_index: 2
                      xpos: 53
                      ypos: 65
                      align: end
                      size: 0.5
                  names:
                    - id: 0
                      entity_index: 0
                      xpos: 50
                      ypos: 95
                      styles:
                        - font-size: 1.2em;
                    - id: 1
                      entity_index: 1
                      xpos: 15
                      ypos: 45
                      styles:
                        - text-anchor: start;
                        - font-size: 0.5em;
                    - id: 2
                      entity_index: 2
                      xpos: 85
                      ypos: 45
                      styles:
                        - text-anchor: end;
                        - font-size: 0.5em;
                    - id: 3
                      entity_index: 7
                      xpos: 0
                      ypos: 12
                      styles:
                        - text-anchor: start;
                        - font-size: 0.5em;
                    - id: 4
                      entity_index: 8
                      xpos: 100
                      ypos: 12
                      styles:
                        - font-size: 0.5em;
                        - text-anchor: end;
                horseshoe_scale:
                  min: 0
                  max: 8000
                  width: 6
                color_stops:
                  0: "#228127"
                  100: "#FFA81D"
                  600: "#9E0000"

              - type: custom:mini-graph-card
                entities:
                  - sensor.efergy_power_usage
                hours_to_show: 24
                height: 150
                show:
                  icon: false
                  name: false
                  state: false
                line_width: 8
                color_thresholds:
                  - value: 40
                    color: "#228127"
                  - value: 100
                    color: "#FFA81D"
                  - value: 600
                    color: "#9E0000"

      - type: vertical-stack
        in_card: true
        cards:
          - type: "custom:button-card"
            template: custom_card_title
            name: Loadshedding 
            card_mod:
              style: |
                ha-card {
                  margin-top: 15px;
                }

          # ----------------------------------------------------------------------------
          # Current loadshedding status
          # ----------------------------------------------------------------------------          
          - type: markdown
            content: >-
              {%- set grid_connected = "binary_sensor.sunsynk_grid_connected" -%}
              {%- set stage_sensor = "sensor.load_shedding_stage_eskom" -%}
              {%- set area_sensor = "sensor.load_shedding_area_jhbcitypower3_13_winchesterhills" -%}
              {%- set stage = state_attr(stage_sensor, "stage") -%}
              {%- set next_stage = state_attr(stage_sensor, "next_stage") -%}
              {%- set next_start = state_attr(stage_sensor, "next_start_time") -%}
              {%- set next_end = state_attr(stage_sensor, "next_end_time") -%}
              {%- set alert = states(stage_sensor) -%}
              {%- set alert_type = "success" -%}
              {% set area_forecast = state_attr(area_sensor, "forecast") -%}
              {%- set starts_in = state_attr(area_sensor, "starts_in") -%}
              {%- set ends_in = state_attr(area_sensor, "ends_in") -%}

              {%- if area_forecast -%}
                {%- set next_start = area_forecast[0].start_time -%}
                {%- set next_end = area_forecast[0].end_time -%}
              {%- endif -%}

              {%- if is_state(area_sensor, "off") and starts_in and next_start and next_end -%}
                {%- set next_in = starts_in if starts_in else 0 -%}
                {%- if next_start == 0 or next_end == 0 -%}
                  {%- set next_time = as_timestamp(next_start, default=0.0) -%}
                  {%- set alert = "Stage {stage}".format(stage=next_stage) + " starts in {d}d {h}h {m}m ({next})" -%}
                {%- elif not stage and starts_in > 1440 -%}
                  {%- set next_time = as_timestamp(next_start, default=0.0) -%}
                  {%- set alert = "No Load Shedding" -%}
                {%- else -%}
                  {%- set next_time = as_timestamp(next_start, default=0.0) -%}
                  {%- set alert = "Load Shedding starts in {d}d {h}h {m}m ({next})" -%}
                {%- endif -%}
                {% if next_in > 1440 %}
                  {%- set alert_type = "success" -%}
                {% elif 1440 >= next_in >= 60 %}
                  {%- set alert_type = "warning" -%}
                {% elif 60 > next_in %}
                  {%- set alert_type = "error" -%}
                {% endif %}
              {%- elif is_state(area_sensor, "on") and ends_in -%}
                {%- set next_time = as_timestamp(next_end, default=0.0) -%}
                {%- set next_in = ends_in if ends_in else 0 -%}
                {%- set alert = "Load Shedding ends in {d}d {h}h {m}m ({next})" -%}
                {%- set alert_type = "error" -%}
              {%- endif -%}

              {%- set next_in_sec = timedelta(minutes=next_in).total_seconds() | int(default=0) // 60 -%}
              {%- set mins = next_in_sec % 60 -%}
              {%- set hrs = next_in_sec // 60 % 24 -%}
              {%- set days = next_in_sec // 1440 -%}
              {%- set alert = alert.format(d=days, m=mins, h=hrs, next=next_time | timestamp_custom("%H:%M", True)) -%}

              <ha-alert alert-type="{{ alert_type }}">{{ alert }}</ha-alert>

            card_mod:
              style: |
                ha-card {
                  margin-top: 10px;
                  margin-bottom: -10px;
                  background: #372A2900;
                }

          # ----------------------------------------------------------------------------
          #  Loadshedding Forecast
          # ----------------------------------------------------------------------------      
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: >
              {% set area_sensor = "sensor.load_shedding_area_jhbcitypower3_13_winchesterhills" %}
              {% set number_of_days = 2 %}
              {% set show_day_borders = false %}
              {% set show_end_times = false %}
              {% set timeslots = 48 %}
              <style>
                  @media (prefers-color-scheme: light) {
                      {% if show_day_borders %}
                      .day_container {
                          background-color: #fbeff3 !important;
                      }
                      {% endif %}

                      .current_time_indicator_text,
                      .current_slot_indicator_start_text,
                      .current_slot_indicator_end_text {
                          color: #785551 !important;
                      }

                      .current_time_indicator,
                      .current_slot_indicator_start,
                      .current_slot_indicator_end {
                          background-color: #785551 !important;
                      }

                      .slot {
                          background-color: #f5ddd9 !important;
                      }
                  }

                  .day_container {
                      {% if show_day_borders %}
                      background-color: #2b2120;
                      border-radius: 0.75rem;
                      {% endif %}
                      padding-top: 0.5rem;
                      padding-bottom: 1.75rem;
                      margin: 0.25rem 0;
                  }

                  h3.day_heading,
                  .current_time_indicator_text,
                  .current_slot_indicator_start_text,
                  .current_slot_indicator_end_text {
                      font-family: Roboto, Ubuntu, sans-serif;
                      font-weight: 600;
                  }

                  h3.day_heading {
                      font-size: 1.0rem;
                      margin: 0 0 0 1rem;
                  }

                  .slot_container {
                      display: grid;
                      grid-template-columns: repeat({{ timeslots }}, 1fr);
                      gap: 0.0625rem;
                      width: calc(100% - 2rem);
                      margin: 0 1rem;
                      line-height: 0.9375rem;
                      position: relative;
                  }

                  .slot_container .slot:first-of-type {
                      border-top-left-radius: 50%;
                      border-bottom-left-radius: 50%;
                  }

                  .slot_container .slot:last-of-type {
                      border-top-right-radius: 50%;
                      border-bottom-right-radius: 50%;
                  }

                  .slot {
                      border-radius: 15%;
                      background-color: #534341;
                  }

                  .active_slot_stage_1 {
                      background-color: #f6a829 !important;
                  }

                  .active_slot_stage_2 {
                      background-color: #f8980d !important;
                  }

                  .active_slot_stage_3 {
                      background-color: #e66e0e !important;
                  }

                  .active_slot_stage_4 {
                      background-color: #e3493f !important;
                  }

                  .active_slot_stage_5 {
                      background-color: #d93e3d !important;
                  }

                  .active_slot_stage_6 {
                      background-color: #cf3131 !important;
                  }

                  .active_slot_stage_7 {
                      background-color: #b21e1d !important;
                  }

                  .active_slot_stage_8 {
                      background-color: black !important;
                  }

                  div.active_slot {
                      background-color: black;
                  }

                  div.fade_slot {
                      opacity:0.2;
                  }

                  .current_time_indicator {
                      width: 0.125rem;
                      position: absolute;
                      height: 120%;
                      top: -10%;
                      border-radius: 15%;
                      transform: translate(-50%, 0);
                      background-color: #e6bdb7;
                  }

                  .current_time_indicator_text {
                      position: absolute;
                      bottom: 140%;
                      transform: translate(-50%, 0);
                      color: #e6bdb7;
                  }

                  .current_slot_indicator_start {
                      width: 0.125rem;
                      position: absolute;
                      height: 40%;
                      top: 100%;
                      border-radius: 15%;
                      transform: translate(-50%, 0);
                      background-color: #e6bdb7;
                  }

                  .current_slot_indicator_start_text {
                      position: absolute;
                      top: 150%;
                      transform: translate(-50%, 0);
                      color: #e6bdb7;
                  }

                  .current_slot_indicator_end {
                      width: 0.125rem;
                      position: absolute;
                      height: 40%;
                      bottom: 100%;
                      border-radius: 15%;
                      transform: translate(-50%, 0);
                      background-color: #e6bdb7;
                  }

                  .current_slot_indicator_end_text {
                      position: absolute;
                      bottom: 150%;
                      transform: translate(-50%, 0);
                      color: #e6bdb7;
                  }
              </style>
              {% set area_schedule = state_attr(area_sensor, "forecast") %}
              {% if area_schedule is none %}{% set area_schedule = [] %}{% endif %}
              {% for day_offset_idx in range(number_of_days) %}
                  {% set today_datetime_midnight = now().replace(hour=0,minute=0,second=0,microsecond=0) + timedelta(days=day_offset_idx) %}
                  <div class="day_container">
                      <h3 class="day_heading"
                          style="{% if day_offset_idx == 0 or show_end_times %} margin-bottom: 1.5rem;
                              {% else %} margin-bottom: 0.5rem;
                              {% endif %}">{{ today_datetime_midnight.strftime("%A, %B %-d") }}</h3>
                      <div class="slot_container">
                          {% set ns = namespace(active_class_name="", last_slot_was_active=false, current_slot_was_activated=false) %}
                          {% for half_hour_time_slot_idx in range(timeslots) %}
                              {% set half_hour_time_slot = today_datetime_midnight + timedelta(minutes=30*half_hour_time_slot_idx) %}
                              {% set ns.active_class_name = "" %}
                              {% set ns.current_slot_was_activated = false %}
                              {% for loadshedding in area_schedule %}
                                  {% if not ns.current_slot_was_activated %}
                                      {% if loadshedding["start_time"] <= half_hour_time_slot < loadshedding["end_time"] %}
                                          {% if not ns.last_slot_was_active %}
                                              {% set percentage_of_region = (half_hour_time_slot_idx/timeslots)*100 %}
                                              <span class="current_slot_indicator_start" style="left:{{ percentage_of_region }}%">&nbsp;</span>
                                              <span class="current_slot_indicator_start_text" style="left:{{ percentage_of_region }}%;
                                                          {% if half_hour_time_slot.hour == 0 %}transform: none;{% elif half_hour_time_slot.hour == 23 %}transform: translate(-100%,0);{% endif %}">{{ half_hour_time_slot.strftime("%H:%M") }}</span>
                                          {% endif %}
                                          {% set ns.current_slot_was_activated = true %}
                                          {% set ns.last_slot_was_active = true %}
                                          {% set ns.active_class_name = "active_slot active_slot_" + loadshedding['stage']|lower|replace(' ','_') %}
                                      {% endif %}
                                  {% endif %}
                              {% endfor %}
                              {% if not ns.current_slot_was_activated %}
                                  {% if show_end_times and ns.last_slot_was_active %}
                                      {% set percentage_of_region = (half_hour_time_slot_idx/timeslots)*100 %}
                                      <span class="current_slot_indicator_end"
                                          style="left:{{ percentage_of_region }}%">&nbsp;</span>
                                      <span class="current_slot_indicator_end_text"
                                          style="left:{{ percentage_of_region }}%;
                                                  {% if half_hour_time_slot.hour == 0 %}transform: none;{% elif half_hour_time_slot.hour == 23 %}transform: translate(-100%,0);{% endif %}">{{ half_hour_time_slot.strftime("%H:%M") }}</span>
                                  {% endif %}
                                  {% set ns.last_slot_was_active = false %}
                              {% endif %}
                              <div class="slot {% if now() > half_hour_time_slot + timedelta(minutes=30) %}fade_slot{% endif %} {{ ns.active_class_name }}">&nbsp;</div>
                          {% endfor %}
                          {% if day_offset_idx == 0 %}
                              {% set current_time_indicator_progress = now().hour*2 + now().minute/30 %}
                              {% set percentage_of_region = (current_time_indicator_progress/timeslots)*100 %}
                              <span class="current_time_indicator"
                                  style="left:{{ percentage_of_region }}%">&nbsp;</span>
                              {% if not show_end_times %}
                                <span class="current_time_indicator_text"
                                    style="left:{{ percentage_of_region }}%">Now</span>
                              {% endif %}
                          {% endif %}
                      </div>
                  </div>
              {% endfor %}

          # ----------------------------------------------------------------------------
          # Load shedding schedude for tomorrow
          # ----------------------------------------------------------------------------
          - type: custom:atomic-calendar-revive
            enableModeChange: true
            firstDayOfWeek: 1
            refreshInterval: 1800
            startDaysAhead: 2
            entities:
              - entity: calendar.load_shedding_forecast
                maxDaysToShow: 2
                showMultiDay: true
            showCurrentEventLine: false
            showMonth: false
            showWeekDay: true
            disableEventLink: true
            showNoEventsForToday: false
            disableLocationLink: true
            showFullDayProgress: false
            showEventIcon: false
            showHiddenText: false
            showCalendarName: false
            calShowDescription: false
            showLastCalendarWeek: true
            disableCalEventLink: true
            disableCalLocationLink: true
            disableCalLink: true
            showDescription: false
            dateFormat: LL
            showDate: false
            sortByStartTime: false
            showRelativeTime: true
            showProgressBar: true
            showLocation: true
            showDeclined: false
            showMultiDayEventParts: false
            showMultiDay: false
            showLoader: false
            maxEventCount: 8
            untilText: "Until"
            compactMode: false
            card_mod:
              style: |
                ha-card {
                  margin-top: 10px;
                }

  - type: vertical-stack
    cards:
      - type: "custom:button-card"
        template: custom_card_title
        name: "Rooms"

      # ----------------------------------------------------------------------------
      # Kitchen
      # ----------------------------------------------------------------------------
      - type: "custom:button-card"
        template: card_title
        label: "Kitchen"

      - type: horizontal-stack
        cards:
          #Fridge
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_fridge_power
            variables:
              ulm_card_graph_icon: mdi:fridge-variant
              ulm_card_graph_color: "var(--google-blue)"
              ulm_card_graph_name: Fridge
              ulm_card_graph_entity: sensor.shelly_fridge_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          #Dishwasher
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_kitchen_dishwasher_power
            variables:
              ulm_card_graph_icon: mdi:dishwasher
              ulm_card_graph_color: "var(--google-red)"
              ulm_card_graph_name: Dishwasher
              ulm_card_graph_entity: sensor.shelly_kitchen_dishwasher_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

      - type: horizontal-stack
        cards:
          #Kettle
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_kitchen_kettle_plug_power
            variables:
              ulm_card_graph_icon: mdi:kettle-outline
              ulm_card_graph_color: "var(--google-green)"
              ulm_card_graph_name: Kettle Plug
              ulm_card_graph_entity: sensor.shelly_kitchen_kettle_plug_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          #Microwave Oven
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_microwave_plug_power
            variables:
              ulm_card_graph_icon: mdi:microwave
              ulm_card_graph_color: "#FFFFFF"
              ulm_card_graph_name: Microwave Oven
              ulm_card_graph_entity: sensor.shelly_microwave_plug_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

      - type: horizontal-stack
        cards:
          #Toaster
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_kitchen_multi_plug_power
            variables:
              ulm_card_graph_icon: mdi:toaster
              ulm_card_graph_color: "var(--google-green)"
              ulm_card_graph_name: Toaster
              ulm_card_graph_entity: sensor.shelly_kitchen_multi_plug_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          - type: "custom:button-card"
            color_type: blank-card

      # ----------------------------------------------------------------------------
      # Office
      # ----------------------------------------------------------------------------

      - type: "custom:button-card"
        template: card_title
        label: "Office"

      - type: horizontal-stack
        cards:
          #Pascal's Desk Plug
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_pascal_desk_power
            variables:
              ulm_card_graph_icon: mdi:desk
              ulm_card_graph_color: "var(--google-blue)"
              ulm_card_graph_name: Pascal's Desk Plug
              ulm_card_graph_entity: sensor.shelly_pascal_desk_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          - type: "custom:button-card"
            color_type: blank-card

      # ----------------------------------------------------------------------------
      # TV Room
      # ----------------------------------------------------------------------------
      - type: "custom:button-card"
        template: card_title
        label: "TV Room"

      - type: horizontal-stack
        cards:
          #TV
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.shelly_upstair_s_tv_plug_power
            variables:
              ulm_card_graph_icon: mdi:television
              ulm_card_graph_color: "var(--google-green)"
              ulm_card_graph_name: TV (24h)
              ulm_card_graph_entity: sensor.shelly_upstair_s_tv_plug_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          - type: "custom:button-card"
            color_type: blank-card

      # ----------------------------------------------------------------------------
      # Garage
      # ----------------------------------------------------------------------------
      - type: "custom:button-card"
        template: card_title
        label: "Garage"

      - type: horizontal-stack
        cards:
          #Whashing Machine
          #- type: "custom:button-card"
          #  template: card_graph
          #  entity: sensor.shelly_washing_machine_energy
          #  variables:
          #    ulm_card_graph_icon: mdi:washing-machine
          #    ulm_card_graph_color: "var(--google-blue)"
          #    ulm_card_graph_name: Washing Machine
          #    ulm_card_graph_entity: sensor.shelly_washing_machine_energy
          #    ulm_card_graph_type: fill
          #    ulm_card_graph_hours: 24
          #    ulm_card_graph_group_by: interval

          #3D Printer
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.tuya_3d_printer_plug_power
            variables:
              ulm_card_graph_icon: mdi:printer-3d
              ulm_card_graph_color: "var(--google-red)"
              ulm_card_graph_name: 3D Printer
              ulm_card_graph_entity: sensor.tuya_3d_printer_plug_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          - type: "custom:button-card"
            color_type: blank-card

      # ----------------------------------------------------------------------------
      # House
      # ----------------------------------------------------------------------------

      - type: "custom:button-card"
        template: card_title
        label: "House"

      - type: horizontal-stack
        cards:
          #Solar Geyser
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.solar_geyser_switch_power
            variables:
              ulm_card_graph_icon: mdi:storage-tank-outline
              ulm_card_graph_color: "var(--google-blue)"
              ulm_card_graph_name: Solar Geyser
              ulm_card_graph_entity: sensor.solar_geyser_switch_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

          #Inverter Grid Usage
          - type: "custom:button-card"
            template: card_graph
            entity: sensor.sunsynk_grid_power
            variables:
              ulm_card_graph_icon: mdi:transmission-tower
              ulm_card_graph_color: "var(--google-red)"
              ulm_card_graph_name: Inverter Grid Usage
              ulm_card_graph_entity: sensor.sunsynk_grid_power
              ulm_card_graph_type: fill
              ulm_card_graph_hours: 24
              ulm_card_graph_group_by: interval

  - type: vertical-stack
    cards:
      - type: "custom:button-card"
        template: card_title
        name: "Last 24 Hours"

      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.sunsynk_pv1_power
        variables:
          ulm_card_power_details_name: Solar Pannels
          ulm_card_power_details_entity: sensor.sunsynk_pv1_power
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: 0
              color: "#DB4437"
            - value: 1000
              color: "#FFA600"
            - value: 2000
              color: "#43A047"

      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.sunsynk_essential_power
        variables:
          ulm_card_power_details_name: Inverter Output
          ulm_card_power_details_entity: sensor.sunsynk_essential_power
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: 0
              color: "#43A047"
            - value: 1000
              color: "#FFA600"
            - value: 2000
              color: "#DB4437"

      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.sunsynk_battery_soc
        variables:
          ulm_card_power_details_name: Battery Charge
          ulm_card_power_details_entity: sensor.sunsynk_battery_soc
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: 0
              color: "#DB4437"
            - value: 20
              color: "#FFA600"
            - value: 40
              color: "#80A1d4"
            - value: 100
              color: "#43A047"

      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.sunsynk_battery_power
        variables:
          ulm_card_power_details_name: Battery Power
          ulm_card_power_details_entity: sensor.sunsynk_battery_power
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: -100
              color: "#43A047"
            - value: 0
              color: "#80A1d4"
            - value: 100
              color: "#FFA600"
            - value: 1000
              color: "#DB4437"

      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.sunsynk_grid_power
        variables:
          ulm_card_power_details_name: Inverter Grid Power Usage
          ulm_card_power_details_entity: sensor.sunsynk_grid_power
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: 0
              color: "#43A047"
            - value: 300
              color: "#FFA600"
            - value: 500
              color: "#DB4437"

  - type: vertical-stack
    cards:
      - type: "custom:button-card"
        template: custom_card_damix48_power_details
        entity: sensor.efergy_power_usage
        variables:
          ulm_card_power_details_name: Total Grid Power Usage
          ulm_card_power_details_entity: sensor.efergy_power_usage
          ulm_card_power_details_hours: 24
          ulm_card_power_details_24hour: true
          ulm_card_power_details_thresholds:
            - value: 0
              color: "#43A047"
            - value: 300
              color: "#FFA600"
            - value: 600
              color: "#DB4437"

      - type: "custom:button-card"
        template: card_title
        name: "Monthly"

      - type: entities
        entities:
          - entity: sensor.efergy_monthly_consumption
          - entity: sensor.efergy_monthly_energy_cost
          - entity: sensor.electricity_maps_co2_intensity
